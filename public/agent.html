<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≥–µ–Ω—Ç - Billboard Tracker</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- –•–µ–¥–µ—Ä -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>Billboard Tracker</h1>
                <div class="header-user">
                    <span id="userName"></span>
                    <button class="btn btn-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="container">
        <div class="stats" id="stats">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <div id="campaignsList">
            <!-- –°–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </main>

    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="#" class="mobile-nav-item active" onclick="showCampaigns()">
                <span class="mobile-nav-icon">üìã</span>
                –ö–∞–º–ø–∞–Ω—ñ—ó
            </a>
            <a href="#" class="mobile-nav-item" onclick="showAddPoint()">
                <span class="mobile-nav-icon">üìç</span>
                –î–æ–¥–∞—Ç–∏
            </a>
        </div>
    </nav>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ -->
    <div id="addPointModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–î–æ–¥–∞—Ç–∏ –Ω–æ—Å—ñ–π</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="addPointForm">
                <div class="form-group">
                    <label for="campaignSelect">–ö–∞–º–ø–∞–Ω—ñ—è</label>
                    <select id="campaignSelect" name="campaignId" required>
                        <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞–º–ø–∞–Ω—ñ—é</option>
                    </select>
                </div>

                <div class="photo-upload">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó (2-3 —à—Ç)</label>
                    <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                        <p>üì∑ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ</p>
                        <p style="font-size: 12px; color: #7f8c8d;">JPG –∞–±–æ PNG –¥–æ 10MB</p>
                    </div>
                    <input type="file" id="photoInput" name="photos" accept="image/*" multiple style="display: none;">
                    <div id="photoPreview" class="photo-preview"></div>
                </div>

                <div class="form-group">
                    <label>üìç –õ–æ–∫–∞—Ü—ñ—è</label>
                    <div id="locationStatus" class="mb-1"></div>
                    <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">
                        –í–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è
                    </button>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="accuracy" name="accuracy">
                </div>

                <div class="form-group">
                    <label for="typeSelect">–¢–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó</label>
                    <select id="typeSelect" name="type" required>
                        <option value="billboard">–ë—ñ–ª–±–æ—Ä–¥</option>
                        <option value="citylights">CityLights</option>
                        <option value="metro">–ú–µ—Ç—Ä–æ</option>
                        <option value="other">–Ü–Ω—à–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="conditionSelect">–°—Ç–∞–Ω</label>
                    <select id="conditionSelect" name="condition" required>
                        <option value="good">‚úÖ –î–æ–±—Ä–∏–π</option>
                        <option value="damaged">‚ö†Ô∏è –ü–æ—à–∫–æ–¥–∂–µ–Ω–∏–π</option>
                        <option value="absent">‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ–π</option>
                        <option value="not_working">üö´ –ù–µ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω—É—î</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="comment">–ö–æ–º–µ–Ω—Ç–∞—Ä (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea id="comment" name="comment" rows="3"></textarea>
                </div>

                <div id="formError" class="error-message"></div>

                <button type="submit" class="btn btn-primary btn-block">
                    <span class="btn-text">–ó–±–µ—Ä–µ–≥—Ç–∏</span>
                    <span class="btn-loading" style="display:none;">
                        <span class="spinner"></span> –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...
                    </span>
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let campaigns = [];
        let selectedPhotos = [];
        let currentLocation = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userResponse = await fetch('/api/auth/me');
                if (!userResponse.ok) {
                    window.location.href = '/';
                    return;
                }
                
                const userData = await userResponse.json();
                currentUser = userData.user;
                document.getElementById('userName').textContent = currentUser.name;
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏
                await loadCampaigns();
                
            } catch (err) {
                console.error('Init error:', err);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                if (response.ok) {
                    campaigns = await response.json();
                    displayCampaigns();
                    updateCampaignSelect();
                    updateStats();
                }
            } catch (err) {
                console.error('Load campaigns error:', err);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏
        function displayCampaigns() {
            const container = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p class="text-center">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–∞–º–ø–∞–Ω—ñ–π</p>';
                return;
            }
            
            container.innerHTML = campaigns.map(campaign => `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${campaign.name}</h3>
                        <span class="card-meta">ID: ${campaign.id.substring(0, 8)}</span>
                    </div>
                    <div class="campaign-stats">
                        <p>–ú–æ—ó —Ç–æ—á–∫–∏: <strong id="points-${campaign.id}">0</strong></p>
                    </div>
                    <button class="btn btn-primary" onclick="selectCampaignAndAdd('${campaign.id}')">
                        –î–æ–¥–∞—Ç–∏ –Ω–æ—Å—ñ–π
                    </button>
                </div>
            `).join('');
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
            campaigns.forEach(campaign => {
                loadCampaignPoints(campaign.id);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏ –∫–∞–º–ø–∞–Ω–∏–∏
        async function loadCampaignPoints(campaignId) {
            try {
                const response = await fetch(`/api/points/campaign/${campaignId}`);
                if (response.ok) {
                    const points = await response.json();
                    const element = document.getElementById(`points-${campaignId}`);
                    if (element) {
                        element.textContent = points.length;
                    }
                }
            } catch (err) {
                console.error('Load points error:', err);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        function updateStats() {
            const totalCampaigns = campaigns.length;
            const activeCampaigns = campaigns.filter(c => c.status === 'active').length;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalCampaigns}</div>
                    <div class="stat-label">–í—Å—å–æ–≥–æ –∫–∞–º–ø–∞–Ω—ñ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${activeCampaigns}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö</div>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±–æ—Ä –∫–∞–º–ø–∞–Ω–∏–π
        function updateCampaignSelect() {
            const select = document.getElementById('campaignSelect');
            select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞–º–ø–∞–Ω—ñ—é</option>' + 
                campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        function showAddPoint() {
            document.getElementById('addPointModal').classList.add('active');
            getCurrentLocation();
        }

        // –í—ã–±—Ä–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –∏ –¥–æ–±–∞–≤–∏—Ç—å
        function selectCampaignAndAdd(campaignId) {
            document.getElementById('campaignSelect').value = campaignId;
            showAddPoint();
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('addPointModal').classList.remove('active');
            resetForm();
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
        function getCurrentLocation() {
            const status = document.getElementById('locationStatus');
            status.innerHTML = '<span style="color: var(--warning-color)">‚è≥ –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è...</span>';
            
            if (!navigator.geolocation) {
                status.innerHTML = '<span style="color: var(--danger-color)">‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è</span>';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    document.getElementById('latitude').value = currentLocation.latitude;
                    document.getElementById('longitude').value = currentLocation.longitude;
                    document.getElementById('accuracy').value = currentLocation.accuracy;
                    
                    status.innerHTML = `
                        <span style="color: var(--success-color)">‚úÖ –ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤–∏–∑–Ω–∞—á–µ–Ω–æ</span>
                        <br><small>–¢–æ—á–Ω—ñ—Å—Ç—å: ¬±${Math.round(currentLocation.accuracy)}–º</small>
                    `;
                },
                (error) => {
                    let errorMsg = '–ü–æ–º–∏–ª–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '–î–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '–ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤–∏—á–µ—Ä–ø–∞–Ω–æ';
                            break;
                    }
                    status.innerHTML = `<span style="color: var(--danger-color)">‚ùå ${errorMsg}</span>`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
        document.getElementById('photoInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('photoPreview');
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 3 —Ñ–æ—Ç–æ
            if (selectedPhotos.length + files.length > 3) {
                alert('–ú–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–∫—Å–∏–º—É–º 3 —Ñ–æ—Ç–æ');
                return;
            }
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`–§–∞–π–ª ${file.name} –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å–∏–º—É–º 10MB)`);
                    return;
                }
                
                selectedPhotos.push(file);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="photo-remove" onclick="removePhoto(${selectedPhotos.length - 1})">&times;</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });

        // –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            selectedPhotos.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="photo-remove" onclick="removePhoto(${index})">&times;</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('addPointForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            const errorMsg = document.getElementById('formError');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!currentLocation) {
                errorMsg.textContent = '–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á—Ç–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è';
                return;
            }
            
            if (selectedPhotos.length < 2) {
                errorMsg.textContent = '–î–æ–¥–∞–π—Ç–µ –º—ñ–Ω—ñ–º—É–º 2 —Ñ–æ—Ç–æ';
                return;
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;
            errorMsg.textContent = '';
            
            try {
                const formData = new FormData();
                formData.append('campaignId', form.campaignId.value);
                formData.append('latitude', currentLocation.latitude);
                formData.append('longitude', currentLocation.longitude);
                formData.append('accuracy', currentLocation.accuracy);
                formData.append('type', form.type.value);
                
                // –ü–æ–ª—É—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                formData.append('condition', form.condition.value);
                
                formData.append('comment', form.comment.value);
                
                // –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                selectedPhotos.forEach(photo => {
                    formData.append('photos', photo);
                });
                
                const response = await fetch('/api/points', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    closeModal();
                    alert('–ù–æ—Å—ñ–π —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!');
                    loadCampaigns(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                } else {
                    const data = await response.json();
                    errorMsg.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è';
                }
                
            } catch (err) {
                errorMsg.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º';
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        function resetForm() {
            document.getElementById('addPointForm').reset();
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('locationStatus').innerHTML = '';
            document.getElementById('formError').textContent = '';
            selectedPhotos = [];
            currentLocation = null;
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (err) {
                console.error('Logout error:', err);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π
        function showCampaigns() {
            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.mobile-nav-item').classList.add('active');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        init();
    </script>
</body>
</html>
