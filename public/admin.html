<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å - Billboard Tracker</title>
    <link rel="stylesheet" href="/css/style.css?v=2">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            height: fit-content;
        }
        
        .map-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        #adminMap {
            height: 600px;
            width: 100%;
            border-radius: 8px;
        }
        
        .point-info {
            padding: 10px;
        }
        
        .point-info img {
            max-width: 200px;
            margin: 5px;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .admin-layout {
                grid-template-columns: 1fr;
            }
            
            #adminMap {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- –•–µ–¥–µ—Ä -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>Billboard Tracker - –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</h1>
                <div class="header-user">
                    <span id="userName"></span>
                    <button class="btn btn-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="container">
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="btn btn-secondary" onclick="showTab('map')" id="mapTab">–ö–∞—Ä—Ç–∞</button>
            <button class="btn btn-secondary" onclick="showTab('campaigns')" id="campaignsTab">–ö–∞–º–ø–∞–Ω—ñ—ó</button>
            <button class="btn btn-secondary" onclick="showTab('users')" id="usersTab">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</button>
            <button class="btn btn-secondary" onclick="showTab('backup')" id="backupTab">–ë—ç–∫–∞–ø–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–∞—Ä—Ç—ã -->
        <div id="mapTabContent" class="tab-content">
            <div class="admin-layout">
                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
                <div class="sidebar">
                    <h3>–§—ñ–ª—å—Ç—Ä–∏</h3>
                    
                    <div class="form-group">
                        <label for="filterCampaign">–ö–∞–º–ø–∞–Ω—ñ—è</label>
                        <select id="filterCampaign" onchange="applyFilters()">
                            <option value="">–í—Å—ñ –∫–∞–º–ø–∞–Ω—ñ—ó</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterAgent">–ê–≥–µ–Ω—Ç</label>
                        <select id="filterAgent" onchange="applyFilters()">
                            <option value="">–í—Å—ñ –∞–≥–µ–Ω—Ç–∏</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterType">–¢–∏–ø</label>
                        <select id="filterType" onchange="applyFilters()">
                            <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                            <option value="billboard">–ë—ñ–ª–±–æ—Ä–¥</option>
                            <option value="citylights">CityLights</option>
                            <option value="metro">–ú–µ—Ç—Ä–æ</option>
                            <option value="other">–Ü–Ω—à–µ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterCondition">–°—Ç–∞–Ω</label>
                        <select id="filterCondition" onchange="applyFilters()">
                            <option value="">–í—Å—ñ —Å—Ç–∞–Ω–∏</option>
                            <option value="good">–î–æ–±—Ä–∏–π</option>
                            <option value="damaged">–ü–æ—à–∫–æ–¥–∂–µ–Ω–∏–π</option>
                            <option value="absent">–í—ñ–¥—Å—É—Ç–Ω—ñ–π</option>
                            <option value="not_working">–ù–µ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω—É—î</option>
                        </select>
                    </div>
                    
                    <div class="stats" id="mapStats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalPoints">0</div>
                            <div class="stat-label">–í—Å—å–æ–≥–æ —Ç–æ—á–æ–∫</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-block mt-2" onclick="exportData()">
                        –ï–∫—Å–ø–æ—Ä—Ç –≤ Excel
                    </button>
                </div>
                
                <!-- –ö–∞—Ä—Ç–∞ -->
                <div class="map-container">
                    <div id="adminMap"></div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π -->
        <div id="campaignsTabContent" class="tab-content" style="display: none;">
            <div class="mb-3">
                <button class="btn btn-primary" onclick="showAddCampaignModal()">
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–∞–º–ø–∞–Ω—ñ—é
                </button>
            </div>
            
            <div id="campaignsList"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="usersTabContent" class="tab-content" style="display: none;">
            <div class="mb-3">
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                </button>
            </div>
            
            <div id="usersList"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –±—ç–∫–∞–ø–æ–≤ -->
        <div id="backupTabContent" class="tab-content" style="display: none;">
            <div class="card">
                <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±—ç–∫–∞–ø–∞–º–∏</h3>
                <p>–ë—ç–∫–∞–ø–∏ –∑–∞—Ö–∏—â–∞—é—Ç—å –≤–∞—à—ñ –¥–∞–Ω—ñ –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö —Å–∏—Å—Ç–µ–º–∏.</p>
                
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="createBackup()">
                        üì¶ –°—Ç–≤–æ—Ä–∏—Ç–∏ –±—ç–∫–∞–ø –∑–∞—Ä–∞–∑
                    </button>
                    <button class="btn btn-secondary" onclick="loadBackupList()">
                        üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
                    </button>
                </div>
                
                <div id="backupStatus" class="mb-3"></div>
                
                <h4>–î–æ—Å—Ç—É–ø–Ω—ñ –±—ç–∫–∞–ø–∏:</h4>
                <div id="backupsList">
                    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –±—ç–∫–∞–ø—ñ–≤...</p>
                </div>
            </div>
            
            <div class="card mt-3">
                <h4>‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±—ç–∫–∞–ø–∏</h4>
                <ul>
                    <li><strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –±—ç–∫–∞–ø–∏:</strong> –°—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –∫–æ–∂–Ω—ñ 6 –≥–æ–¥–∏–Ω</li>
                    <li><strong>–©–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è:</strong> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ, –∫–∞–º–ø–∞–Ω—ñ—ó, —Ç–æ—á–∫–∏, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó</li>
                    <li><strong>–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è:</strong> 10 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –±—ç–∫–∞–ø—ñ–≤</li>
                    <li><strong>–†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è:</strong> –ü–∞–ø–∫–∞ /backups –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–ø–∞–Ω–∏–∏ -->
    <div id="campaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="campaignModalTitle">–ù–æ–≤–∞ –∫–∞–º–ø–∞–Ω—ñ—è</h2>
                <button class="modal-close" onclick="closeCampaignModal()">&times;</button>
            </div>
            
            <form id="campaignForm">
                <input type="hidden" id="campaignId" name="id">
                
                <div class="form-group">
                    <label for="campaignName">–ù–∞–∑–≤–∞ –∫–∞–º–ø–∞–Ω—ñ—ó</label>
                    <input type="text" id="campaignName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="campaignStartDate">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
                    <input type="date" id="campaignStartDate" name="startDate">
                </div>
                
                <div class="form-group">
                    <label for="campaignEndDate">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</label>
                    <input type="date" id="campaignEndDate" name="endDate">
                </div>
                
                <div class="form-group">
                    <label for="campaignAgents">–ü—Ä–∏–∑–Ω–∞—á–µ–Ω—ñ –∞–≥–µ–Ω—Ç–∏</label>
                    <select id="campaignAgents" name="agents" multiple style="height: 100px;">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                    <small>–£—Ç—Ä–∏–º—É–π—Ç–µ Ctrl –¥–ª—è –≤–∏–±–æ—Ä—É –¥–µ–∫—ñ–ª—å–∫–æ—Ö</small>
                </div>
                
                <div class="form-group">
                    <label for="campaignInstructions">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó</label>
                    <textarea id="campaignInstructions" name="instructions" rows="3"></textarea>
                </div>
                
                <div id="campaignError" class="error-message"></div>
                
                <button type="submit" class="btn btn-primary btn-block">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userModalTitle">–ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId" name="id">
                
                <div class="form-group">
                    <label for="userUsername">–õ–æ–≥—ñ–Ω</label>
                    <input type="text" id="userUsername" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="userPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="userPassword" name="password" placeholder="–ó–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ">
                </div>
                
                <div class="form-group">
                    <label for="userName">–Ü–º'—è</label>
                    <input type="text" id="userNameInput" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="userRole">–†–æ–ª—å</label>
                    <select id="userRole" name="role" required>
                        <option value="agent">–ê–≥–µ–Ω—Ç</option>
                        <option value="admin">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                
                <div id="userError" class="error-message"></div>
                
                <button type="submit" class="btn btn-primary btn-block">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Leaflet Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let currentUser = null;
        let map = null;
        let markers = [];
        let campaigns = [];
        let users = [];
        let points = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userResponse = await fetch('/api/auth/me');
                if (!userResponse.ok || userResponse.status === 403) {
                    window.location.href = '/';
                    return;
                }
                
                const userData = await userResponse.json();
                currentUser = userData.user;
                document.getElementById('userName').textContent = currentUser.name;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É
                initMap();
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                await Promise.all([
                    loadCampaigns(),
                    loadUsers(),
                    loadMapPoints()
                ]);
                
            } catch (err) {
                console.error('Init error:', err);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            // –¶–µ–Ω—Ç—Ä –£–∫—Ä–∞–∏–Ω—ã
            map = L.map('adminMap').setView([48.3794, 31.1656], 6);
            
            // –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–ª—ã OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
        async function loadMapPoints() {
            try {
                const filters = {
                    campaignId: document.getElementById('filterCampaign').value,
                    agentId: document.getElementById('filterAgent').value,
                    type: document.getElementById('filterType').value,
                    condition: document.getElementById('filterCondition').value
                };
                
                const params = new URLSearchParams();
                Object.keys(filters).forEach(key => {
                    if (filters[key]) params.append(key, filters[key]);
                });
                
                const response = await fetch(`/api/points/map?${params}`);
                if (response.ok) {
                    points = await response.json();
                    displayPointsOnMap();
                    updateMapStats();
                }
            } catch (err) {
                console.error('Load map points error:', err);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
        function displayPointsOnMap() {
            // –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            points.forEach(point => {
                const color = getConditionColor(point.condition);
                const marker = L.circleMarker([point.latitude, point.longitude], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // –ü–æ–ø–∞–ø —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                const popupContent = `
                    <div class="point-info">
                        <h4>${point.campaignName}</h4>
                        <p><strong>–ê–≥–µ–Ω—Ç:</strong> ${point.userName}</p>
                        <p><strong>–¢–∏–ø:</strong> ${getTypeName(point.type)}</p>
                        <p><strong>–°—Ç–∞–Ω:</strong> ${getConditionName(point.condition)}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${new Date(point.createdAt).toLocaleString('uk-UA')}</p>
                        ${point.comment ? `<p><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong> ${point.comment}</p>` : ''}
                        ${point.photos.map(photo => `<img src="${photo}" alt="–§–æ—Ç–æ">`).join('')}
                    </div>
                `;
                
                marker.bindPopup(popupContent, { maxWidth: 300 });
                marker.addTo(map);
                markers.push(marker);
            });
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ —Ç–æ—á–∫–∞—Ö
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }



        // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞
        function getTypeName(type) {
            const types = {
                'billboard': '–ë—ñ–ª–±–æ—Ä–¥',
                'citylights': 'CityLights',
                'metro': '–ú–µ—Ç—Ä–æ',
                'other': '–Ü–Ω—à–µ'
            };
            return types[type] || type;
        }

        // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function getConditionName(condition) {
            const conditions = {
                'good': '–î–æ–±—Ä–∏–π',
                'damaged': '–ü–æ—à–∫–æ–¥–∂–µ–Ω–∏–π',
                'absent': '–í—ñ–¥—Å—É—Ç–Ω—ñ–π',
                'not_working': '–ù–µ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω—É—î'
            };
            return conditions[condition] || condition;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function getConditionColor(condition) {
            const colors = {
                'good': '#27AE60',
                'damaged': '#F39C12', 
                'absent': '#E74C3C',
                'not_working': '#95A5A6'
            };
            return colors[condition] || '#3498DB';
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞—Ä—Ç—ã
        function updateMapStats() {
            document.getElementById('totalPoints').textContent = points.length;
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        function applyFilters() {
            loadMapPoints();
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        async function exportData() {
            try {
                const filters = {
                    campaignId: document.getElementById('filterCampaign').value,
                    agentId: document.getElementById('filterAgent').value,
                    type: document.getElementById('filterType').value,
                    condition: document.getElementById('filterCondition').value
                };
                
                // –°–æ–∑–¥–∞—Ç—å CSV
                let csv = '–ö–∞–º–ø–∞–Ω—ñ—è,–ê–≥–µ–Ω—Ç,–¢–∏–ø,–°—Ç–∞–Ω,–®–∏—Ä–æ—Ç–∞,–î–æ–≤–≥–æ—Ç–∞,–ö–æ–º–µ–Ω—Ç–∞—Ä,–î–∞—Ç–∞\n';
                
                points.forEach(point => {
                    csv += `"${point.campaignName}","${point.userName}","${getTypeName(point.type)}","${getConditionName(point.condition)}",${point.latitude},${point.longitude},"${point.comment || ''}","${new Date(point.createdAt).toLocaleString('uk-UA')}"\n`;
                });
                
                // –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `billboard_tracker_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
            } catch (err) {
                console.error('Export error:', err);
                alert('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É –¥–∞–Ω–∏—Ö');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                if (response.ok) {
                    campaigns = await response.json();
                    updateCampaignFilters();
                    displayCampaigns();
                }
            } catch (err) {
                console.error('Load campaigns error:', err);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∫–∞–º–ø–∞–Ω–∏–π
        function updateCampaignFilters() {
            const select = document.getElementById('filterCampaign');
            select.innerHTML = '<option value="">–í—Å—ñ –∫–∞–º–ø–∞–Ω—ñ—ó</option>' + 
                campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏
        function displayCampaigns() {
            const container = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p class="text-center">–ù–µ–º–∞—î –∫–∞–º–ø–∞–Ω—ñ–π</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞</th>
                                <th>–ü–æ—á–∞—Ç–æ–∫</th>
                                <th>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è</th>
                                <th>–ê–≥–µ–Ω—Ç—ñ–≤</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î—ñ—ó</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${campaigns.map(campaign => `
                                <tr>
                                    <td>${campaign.name}</td>
                                    <td>${campaign.startDate ? new Date(campaign.startDate).toLocaleDateString('uk-UA') : '-'}</td>
                                    <td>${campaign.endDate ? new Date(campaign.endDate).toLocaleDateString('uk-UA') : '-'}</td>
                                    <td>${campaign.agents ? campaign.agents.length : 0}</td>
                                    <td>${campaign.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="editCampaign('${campaign.id}')">
                                            –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    users = await response.json();
                    updateAgentFilters();
                    displayUsers();
                }
            } catch (err) {
                console.error('Load users error:', err);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∞–≥–µ–Ω—Ç–æ–≤
        function updateAgentFilters() {
            const select = document.getElementById('filterAgent');
            const agents = users.filter(u => u.role === 'agent');
            select.innerHTML = '<option value="">–í—Å—ñ –∞–≥–µ–Ω—Ç–∏</option>' + 
                agents.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function displayUsers() {
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-center">–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>–õ–æ–≥—ñ–Ω</th>
                                <th>–Ü–º'—è</th>
                                <th>–†–æ–ª—å</th>
                                <th>–ê–∫—Ç–∏–≤–Ω–∏–π</th>
                                <th>–î—ñ—ó</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.username}</td>
                                    <td>${user.name}</td>
                                    <td>${user.role === 'admin' ? '–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ê–≥–µ–Ω—Ç'}</td>
                                    <td>${user.isActive ? '‚úÖ' : '‚ùå'}</td>
                                    <td>
                                        ${user.id !== 'admin' ? `
                                            <button class="btn btn-secondary" onclick="editUser('${user.id}')">
                                                –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É
        function showTab(tab) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // –°–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.tabs button').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(`${tab}TabContent`).style.display = 'block';
            document.getElementById(`${tab}Tab`).classList.remove('btn-secondary');
            document.getElementById(`${tab}Tab`).classList.add('btn-primary');
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –Ω–µ–µ
            if (tab === 'map' && map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            if (tab === 'backup') {
                loadBackupList();
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏—è–º–∏
        function showAddCampaignModal() {
            document.getElementById('campaignModalTitle').textContent = '–ù–æ–≤–∞ –∫–∞–º–ø–∞–Ω—ñ—è';
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignId').value = '';
            updateCampaignAgentsSelect();
            document.getElementById('campaignModal').classList.add('active');
        }

        function editCampaign(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;
            
            document.getElementById('campaignModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞–º–ø–∞–Ω—ñ—é';
            document.getElementById('campaignId').value = campaign.id;
            document.getElementById('campaignName').value = campaign.name;
            document.getElementById('campaignStartDate').value = campaign.startDate ? campaign.startDate.split('T')[0] : '';
            document.getElementById('campaignEndDate').value = campaign.endDate ? campaign.endDate.split('T')[0] : '';
            document.getElementById('campaignInstructions').value = campaign.instructions || '';
            
            updateCampaignAgentsSelect();
            
            // –í—ã–±—Ä–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
            const select = document.getElementById('campaignAgents');
            if (campaign.agents) {
                Array.from(select.options).forEach(option => {
                    option.selected = campaign.agents.includes(option.value);
                });
            }
            
            document.getElementById('campaignModal').classList.add('active');
        }

        function updateCampaignAgentsSelect() {
            const select = document.getElementById('campaignAgents');
            const agents = users.filter(u => u.role === 'agent');
            select.innerHTML = agents.map(a => 
                `<option value="${a.id}">${a.name}</option>`
            ).join('');
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').classList.remove('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
        document.getElementById('campaignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const errorMsg = document.getElementById('campaignError');
            
            try {
                const selectedAgents = Array.from(form.agents.selectedOptions).map(o => o.value);
                
                const data = {
                    name: form.name.value,
                    startDate: form.startDate.value,
                    endDate: form.endDate.value,
                    agents: selectedAgents,
                    instructions: form.instructions.value
                };
                
                const campaignId = form.id.value;
                const url = campaignId ? `/api/campaigns/${campaignId}` : '/api/campaigns';
                const method = campaignId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeCampaignModal();
                    await loadCampaigns();
                } else {
                    const error = await response.json();
                    errorMsg.textContent = error.error || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è';
                }
                
            } catch (err) {
                errorMsg.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = '–ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userUsername').disabled = false;
            document.getElementById('userPassword').required = true;
            document.getElementById('userModal').classList.add('active');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞';
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userUsername').disabled = true;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('userNameInput').value = user.name;
            document.getElementById('userRole').value = user.role;
            
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const errorMsg = document.getElementById('userError');
            
            try {
                const data = {
                    username: form.username.value,
                    name: form.name.value,
                    role: form.role.value
                };
                
                if (form.password.value) {
                    data.password = form.password.value;
                }
                
                const userId = form.id.value;
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeUserModal();
                    await loadUsers();
                } else {
                    const error = await response.json();
                    errorMsg.textContent = error.error || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è';
                }
                
            } catch (err) {
                errorMsg.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è';
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏
        async function createBackup() {
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.innerHTML = '<span style="color: var(--warning-color)">‚è≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—ç–∫–∞–ø–∞...</span>';
            
            try {
                const response = await fetch('/api/backup/create', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '<span style="color: var(--success-color)">‚úÖ –ë—ç–∫–∞–ø —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!</span>';
                    loadBackupList();
                } else {
                    statusDiv.innerHTML = `<span style="color: var(--danger-color)">‚ùå ${data.error}</span>`;
                }
            } catch (err) {
                statusDiv.innerHTML = '<span style="color: var(--danger-color)">‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—ç–∫–∞–ø–∞</span>';
            }
        }

        async function loadBackupList() {
            try {
                const response = await fetch('/api/backup/list');
                const backups = await response.json();
                
                const listDiv = document.getElementById('backupsList');
                
                if (backups.length === 0) {
                    listDiv.innerHTML = '<p>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –±—ç–∫–∞–ø—ñ–≤</p>';
                    return;
                }
                
                listDiv.innerHTML = `
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>–§–∞–π–ª –±—ç–∫–∞–ø–∞</th>
                                    <th>–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</th>
                                    <th>–î—ñ—ó</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${backups.map(backup => {
                                    const date = backup.match(/backup-(.+)\.tar\.gz/)?.[1]?.replace(/[-T]/g, ' ').replace(/\..+/, '') || '–ù–µ–≤—ñ–¥–æ–º–∞ –¥–∞—Ç–∞';
                                    return `
                                        <tr>
                                            <td>${backup}</td>
                                            <td>${date}</td>
                                            <td>
                                                <button class="btn btn-secondary" onclick="downloadBackup('${backup}')">
                                                    üíæ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                                                </button>
                                                <button class="btn btn-warning" onclick="restoreBackup('${backup}')" 
                                                        style="margin-left: 10px;">
                                                    üîÑ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                document.getElementById('backupsList').innerHTML = '<p style="color: var(--danger-color)">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –±—ç–∫–∞–ø—ñ–≤</p>';
            }
        }

        function downloadBackup(filename) {
            window.open(`/api/backup/download/${filename}`, '_blank');
        }

        async function restoreBackup(filename) {
            if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∑ –±—ç–∫–∞–ø–∞ "${filename}"?\n\n–ü–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞–º—ñ–Ω–µ–Ω—ñ!`)) {
                return;
            }
            
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.innerHTML = '<span style="color: var(--warning-color)">‚è≥ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –±—ç–∫–∞–ø–∞...</span>';
            
            try {
                const response = await fetch('/api/backup/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backupFile: `./backups/${filename}` })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '<span style="color: var(--success-color)">‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</span>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<span style="color: var(--danger-color)">‚ùå ${data.error}</span>`;
                }
            } catch (err) {
                statusDiv.innerHTML = '<span style="color: var(--danger-color)">‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è</span>';
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (err) {
                console.error('Logout error:', err);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init();
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        showTab('map');
    </script>
</body>
</html>
