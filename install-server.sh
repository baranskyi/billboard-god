#!/bin/bash

# Billboard Tracker - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: curl -sSL https://raw.githubusercontent.com/YOUR_USERNAME/billboard-tracker/main/install-server.sh | bash

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Billboard Tracker..."

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É
echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É..."
apt update && apt upgrade -y

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 18
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js..."
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
apt-get install -y nodejs

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
npm install -g pm2

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Nginx
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Nginx..."
apt install nginx -y

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Git
apt install git -y

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üë§ –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è billboard..."
useradd -m -s /bin/bash billboard
usermod -aG sudo billboard

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
cd /home/billboard

# –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
echo "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º Billboard Tracker..."
git clone https://github.com/YOUR_USERNAME/billboard-tracker.git
cd billboard-tracker

# –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤
chown -R billboard:billboard /home/billboard/billboard-tracker

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è billboard
sudo -u billboard bash << 'EOF'
cd /home/billboard/billboard-tracker

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
cp env.example .env

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
SECRET_KEY=$(openssl rand -base64 32)
sed -i "s/your-secret-key-here/$SECRET_KEY/" .env

echo "üîë –í–Ω–∏–º–∞–Ω–∏–µ! –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –≤ —Ñ–∞–π–ª–µ .env"
echo "–§–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: /home/billboard/billboard-tracker/.env"
EOF

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º PM2
echo "üöÄ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º PM2..."
sudo -u billboard pm2 start /home/billboard/billboard-tracker/server.js --name billboard-tracker
sudo -u billboard pm2 startup
sudo -u billboard pm2 save

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Nginx
echo "üåê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Nginx..."
cat > /etc/nginx/sites-available/billboard-tracker << 'EOF'
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
        client_max_body_size 50M;
    }
}
EOF

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–∞–π—Ç
ln -sf /etc/nginx/sites-available/billboard-tracker /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx
nginx -t && systemctl restart nginx

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä
echo "üîí –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä..."
ufw allow ssh
ufw allow 'Nginx Full'
ufw --force enable

echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üéâ Billboard Tracker –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://$(curl -s ifconfig.me)"
echo ""
echo "üîë –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:"
echo "   –õ–æ–≥–∏–Ω: admin"
echo "   –ü–∞—Ä–æ–ª—å: admin123 (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–∑–º–µ–Ω–∏—Ç–µ –≤ .env —Ñ–∞–π–ª–µ!)"
echo ""
echo "üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: sudo -u billboard pm2 status"
echo "   –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:   sudo -u billboard pm2 logs billboard-tracker"
echo "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:        sudo -u billboard pm2 restart billboard-tracker"
echo "   –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env: nano /home/billboard/billboard-tracker/.env"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –≤ /home/billboard/billboard-tracker/.env"
